function trimLeft(t,e){if(!e||" "==e)return $.trim(t);for(;0==t.indexOf(e);)t=t.substring(e.length);return t}function json(str){return eval("("+str+")")}function t(){var t=arguments;if(t.length<=1)return t[0];var e=t[0];if(!e)return e;var n="LEAAEL";e=e.replace(/\?/g,n);for(var o=1;o<=t.length;++o)e=e.replace(n,t[o]);return e}function arrayEqual(t,e){return t=t||[],e=e||[],t.join(",")==e.join(",")}function isArray(t){return"[object Array]"===Object.prototype.toString.call(t)}function isEmpty(t){return t?isArray(t)&&0==t.length?!0:!1:!0}function getFormJsonData(t){var e=formArrDataToJson($("#"+t).serializeArray());return e}function formArrDataToJson(t){var e={},n={};for(var o in t){var r=t[o].name,i=t[o].value;"[]"!=r.substring(r.length-2,r.length)?e[r]=i:(r=r.substring(0,r.length-2),void 0==n[r]?n[r]=[i]:n[r].push(i))}return $.extend(e,n)}function formSerializeDataToJson(t){for(var e=t.split("&"),n={},o={},r=0;r<e.length;++r){var i=e[r].split("="),a=decodeURI(i[0]),s=decodeURI(i[1]);"[]"!=a.substring(a.length-2,a.length)?n[a]=s:(a=a.substring(0,a.length-2),void 0==o[a]?o[a]=[s]:o[a].push(s))}return $.extend(n,o)}function _ajaxCallback(t,e,n){if(t===!0||"true"==t||"object"==typeof t){if(t&&"object"==typeof t&&"NOTLOGIN"==t.Msg)return void alert("你还没有登录, 请先登录!");"function"==typeof e&&e(t)}else"function"==typeof n?n(t):alert("error!")}function _ajax(t,e,n,o,r,i){return log("-------------------ajax:"),log(e),log(n),i="undefined"==typeof i?!0:!1,$.ajax({type:t,url:e,data:n,async:i,success:function(t){_ajaxCallback(t,o,r)},error:function(t){_ajaxCallback(t,o,r)}})}function ajaxGet(t,e,n,o,r){return _ajax("GET",t,e,n,o,r)}function ajaxPost(t,e,n,o,r){_ajax("POST",t,e,n,o,r)}function ajaxPostJson(t,e,n,o,r){log("-------------------ajaxPostJson:"),log(t),log(e),r="undefined"==typeof r?!0:!1,$.ajax({url:t,type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",async:r,data:JSON.stringify(e),success:function(t,e){_ajaxCallback(t,n,o)},error:function(t){_ajaxCallback(t,n,o)}})}function findParents(t,e){if($(t).is(e))return $(t);for(var n=$(t).parents(),o=0;o<n.length;++o)if(log(n.eq(o)),n.eq(o).is(e))return n.seq(o);return null}function getVendorPrefix(){for(var t=document.body||document.documentElement,e=t.style,n=["webkit","khtml","moz","ms","o"],o=0;o<n.length;){if("string"==typeof e[n[o]+"Transition"])return n[o];o++}}function editorIframeTabindex(t){var e=$("#editorContent");e.attr("tabindex",t),setTimeout(function(){e.attr("tabindex",t)},500),setTimeout(function(){e.attr("tabindex",t)},1e3)}function switchEditor(t){LEA.isM=t,t?($("#mdEditor").css("z-index",3).show(),editorIframeTabindex(3),$("#wmd-input").attr("tabindex",2),$("#leanoteNav").hide()):($("#editor").show(),$("#mdEditor").css("z-index",1).hide(),editorIframeTabindex(2),$("#wmd-input").attr("tabindex",3),$("#leanoteNav").show())}function setEditorContent(t,e,n,o){t||(t=""),clearIntervalForSetContent&&clearInterval(clearIntervalForSetContent),e&&(MD?(MD.setContent(t),o&&o(),LEA.s4=new Date,LEA.s4_1=LEA.s4.getTime()-LEA.s1.getTime()):clearIntervalForSetContent=setTimeout(function(){setEditorContent(t,!0,!1,o)},100))}function previewIsEmpty(t){return t&&t.substr(0,previewToken.length)!=previewToken?!1:!0}function isAceError(t){return t?-1!=t.indexOf("XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"):!1}function getEditorContent(t){return t?[MD.getContent(),"<div>"+$("#preview-contents").html()+"</div>"]:void 0}function disableEditor(){var t=tinymce.activeEditor;t&&(t.hide(),LEA.editorStatus=!1,$("#mceTollbarMark").show().css("z-index",1e3))}function enableEditor(){if(!LEA.editorStatus){$("#mceTollbarMark").css("z-index",-1).hide();var t=tinymce.activeEditor;t&&t.show()}}function showDialog(t,e){$("#leanoteDialog #modalTitle").html(e.title),$("#leanoteDialog .modal-body").html($("#"+t+" .modal-body").html()),$("#leanoteDialog .modal-footer").html($("#"+t+" .modal-footer").html()),delete e.title,e.show=!0,$("#leanoteDialog").modal(e)}function hideDialog(t){t||(t=0),setTimeout(function(){$("#leanoteDialog").modal("hide")},t)}function closeDialog(){$(".modal").modal("hide")}function showDialog2(t,e){e=e||{},e.show=!0,$(t).modal(e)}function hideDialog2(t,e){e||(e=0),setTimeout(function(){$(t).modal("hide")},e)}function showDialogRemote(t,e){e=e||{},t+="?";for(var n in e)t+=n+"="+e[n]+"&";$("#leanoteDialogRemote").modal({remote:t})}function hideDialogRemote(t){t?setTimeout(function(){$("#leanoteDialogRemote").modal("hide")},t):$("#leanoteDialogRemote").modal("hide")}function notifyInfo(t){$.pnotify({title:"通知",text:t,type:"info",styling:"bootstrap"})}function notifyError(t){$.pnotify.defaults.delay=2e3,$.pnotify({title:"通知",text:t,type:"error",styling:"bootstrap"})}function notifySuccess(t){$.pnotify({title:"通知",text:t,type:"success",styling:"bootstrap"})}function goNowToDatetime(t){return t?t.substr(0,10)+" "+t.substr(11,8):""}function getCurDate(){return(new Date).format("yyyy-M-d")}function enter(t,e,n){t||(t="body"),$(t).on("keydown",e,function(t){13==t.keyCode&&n.call(this)})}function enterBlur(t,e){t||(t="body"),e||(e=t,t="body"),$(t).on("keydown",e,function(t){13==t.keyCode&&$(this).trigger("blur")})}function getObjectId(){return ObjectId()}function resizeEditor(t){return}function showMsg(t,e){$("#msg").html(t),e&&setTimeout(function(){$("#msg").html("")},e)}function showMsg2(t,e,n){$(t).html(e),n&&setTimeout(function(){$(t).html("")},n)}function showAlert(t,e,n,o){$(t).html(e).removeClass("alert-danger").removeClass("alert-success").removeClass("alert-warning").addClass("alert-"+n).show(),o&&$(o).focus()}function hideAlert(t,e){e?setTimeout(function(){$(t).hide()},e):$(t).hide()}function post(t,e,n,o){o&&$(o).button("loading"),ajaxPost(t,e,function(t){o&&$(o).button("reset"),"object"==typeof t?"function"==typeof n&&n(t):alert("leanote出现了错误!")})}function isEmail(t){var e=/^([a-zA-Z0-9]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+@([a-zA-Z0-9\-]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+\.[0-9a-zA-Z]{2,3}$/;return e.test(t)}function isEmailFromInput(t,e,n,o){var r=$(t).val(),i=function(){};if(e&&(i=function(e,n){showAlert(e,n,"danger",t)}),r){if(isEmail(r))return r;i(e,o||getMsg("errorEmail"))}else i(e,n||getMsg("inputEmail"))}function initCopy(t,e){var n=new ZeroClipboard(document.getElementById(t),{moviePath:"/js/ZeroClipboard/ZeroClipboard.swf"});n.on("complete",function(t,n){e(n)})}function showLoading(){$("#loading").css("visibility","visible")}function hideLoading(){$("#loading").css("visibility","hidden")}function setCookie(t,e,n){var o=new Date;o.setDate(o.getDate()+n),document.cookie=t+"="+escape(e)+(null==n?"":";expires="+o.toGMTString())}function logout(){setCookie("LEANOTE_SESSION","",-1),location.href=UrlPrefix+"/logout?id=1"}function getImageSize(t,e){function n(t,n){o.parentNode.removeChild(o),e({width:t,height:n})}var o=document.createElement("img");o.onload=function(){n(o.clientWidth,o.clientHeight)},o.onerror=function(){n()},o.src=t;var r=o.style;r.visibility="hidden",r.position="fixed",r.bottom=r.left=0,r.width=r.height="auto",document.body.appendChild(o)}function hiddenIframeBorder(){$(".mce-window iframe").attr("frameborder","no").attr("scrolling","no")}function getEmailLoginAddress(t){if(t){var e=t.split("@");if(e&&!(e.length<2)){var n=e[1];return email2LoginAddress[n]||"http://mail."+n}}}function reIsOk(t){return t&&"object"==typeof t&&t.Ok}function saveBookmark(){try{if(LEA.bookmark=tinymce.activeEditor.selection.getBookmark(),LEA.bookmark&&LEA.bookmark.id){var t=$($("#editorContent_ifr").contents()),e=t.find("body"),n=e.children().eq(0);if(n.is("span")){var o=n,r=o.eq(0);r.attr("id")==LEA.bookmark.id+"_start"?(LEA.hasBookmark=!1,r.remove()):LEA.hasBookmark=!0}else if(n.is("p")){var o=n.children();if(1==o.length&&""==$.trim(n.text())){var r=o.eq(0);r.attr("id")==LEA.bookmark.id+"_start"?(LEA.hasBookmark=!1,n.remove()):LEA.hasBookmark=!0}else LEA.hasBookmark=!0}}}catch(i){}}function restoreBookmark(){try{if(LEA.hasBookmark){var t=tinymce.activeEditor;t.focus(),t.selection.moveToBookmark(LEA.bookmark)}}catch(e){}}function getHashObject(){var t=location.hash;if(!t)return{};for(var e=t.substr(1),n=e.split("&"),o={},r=0;r<n.length;++r){var i=n[r].split("=");2==i.length&&(o[i[0]]=i[1])}return o}function getHash(t,e){var n=getHashObject();return n[t]}function setHash(t,e){var n=location.hash;if(!n)return void(location.href="#"+t+"="+e);var o=getHashObject();o[t]=e;var r="";for(var i in o)o[i]&&(r&&(r+="&"),r+=i+"="+o[i]);location.href="#"+r}if("undefined"==typeof LEA)var LEA={};var Notebook={cache:{}},Note={cache:{}},Tag={},Notebook={},Share={},Mobile={},LeaAce={},Converter,MarkdownEditor,ScrollLink,MD,tt=t;LEA.isM=!1,LEA.isMarkdownEditor=function(){return LEA.isM};var previewToken="<div style='display: none'>FORTOKEN</div>",clearIntervalForSetContent;LEA.editorStatus=!0,$(function(){$.pnotify&&($.pnotify.defaults.delay=1e3)}),Date.prototype.format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var n in e)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[n]:("00"+e[n]).substr((""+e[n]).length)));return t};var email2LoginAddress={"qq.com":"http://mail.qq.com","gmail.com":"http://mail.google.com","sina.com":"http://mail.sina.com.cn","163.com":"http://mail.163.com","126.com":"http://mail.126.com","yeah.net":"http://www.yeah.net/","sohu.com":"http://mail.sohu.com/","tom.com":"http://mail.tom.com/","sogou.com":"http://mail.sogou.com/","139.com":"http://mail.10086.cn/","hotmail.com":"http://www.hotmail.com","live.com":"http://login.live.com/","live.cn":"http://login.live.cn/","live.com.cn":"http://login.live.com.cn","189.com":"http://webmail16.189.cn/webmail/","yahoo.com.cn":"http://mail.cn.yahoo.com/","yahoo.cn":"http://mail.cn.yahoo.com/","eyou.com":"http://www.eyou.com/","21cn.com":"http://mail.21cn.com/","188.com":"http://www.188.com/","foxmail.com":"http://mail.foxmail.com"};LEA.bookmark=null,LEA.hasBookmark=!1;var vd={isInt:function(t){var e=/^0$|^[1-9]\d*$/;return result=e.test(t),result},isNumeric:function(t){return $.isNumeric(t)},isFloat:function(t){var e=/^0(\.\d+)?$|^[1-9]\d*(\.\d+)?$/;return result=e.test(t),result},isEmail:function(t){var e=/^([a-zA-Z0-9]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+@([a-zA-Z0-9\-]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+\.[0-9a-zA-Z]{2,3}$/;return result=e.test(t),result},isBlank:function(t){return!$.trim(t)},has_special_chars:function(t){return/['"#$%&\^<>\?*]/.test(t)},init:function(form,rule_funcs){function is_required(t){var e=get_name(t),n=get_rules(t,e),o=n[0];return"required"==o.rule?!0:!1}function get_rules(target,name){return rules[name]||(rules[name]=eval("("+target.data("rules")+")")),rules[name]}function get_msg_target(t,e){if(!msg_targets[e]){var n=t.data("msg_target");if(n)msg_targets[e]=$(n);else{var o=$('<div class="help-block alert alert-warning" style="display: block;"></div>');t.parent().append(o),msg_targets[e]=o}}return msg_targets[e]}function hide_msg(t,e){var n=get_msg_target(t,e);n.hasClass("alert-success")||n.hide()}function show_msg(t,e,n,o){var r=get_msg_target(t,e);r.html(getMsg(n,o)).removeClass("hide alert-success").addClass("alert-danger").show()}function pre_fix(t){var e=t.data("pre_fix");if(e)switch(e){case"int":int_fix(t);break;case"price":price_fix(t);break;case"decimal":decimal_fix(t)}}function apply_rules(t,e){var n=get_rules(t,e);if(pre_fix(t),!n)return!0;for(var o=0;o<n.length;++o){var r=n[o],i=r.rule,a=r.msg,s=r.msgData;if(!rule_funcs[i](t,r))return show_msg(t,e,a,s),!1}hide_msg(t,e);var l=t.data("post_rule");return l&&setTimeout(function(){var t=$(l);apply_rules(t,get_name(t))},0),!0}function focus_func(t){var e=$(t.target),n=get_name(e);hide_msg(e,n),pre_fix(e)}function unfocus_func(t){var e=$(t.target),n=get_name(e);apply_rules(e,n)}function get_name(t){return t.data("u_name")||t.attr("name")||t.attr("id")}var get_val=function(t){if(t.is(":checkbox")){var e=t.attr("name"),n=$('input[name="'+e+'"]:checked').length;return n}return t.is(":radio")?void 0:t.val()},default_rule_funcs={required:function(t){return get_val(t)},min:function(t,e){var n=get_val(t);return(""!==n||is_required(t))&&n<e.data?!1:!0},minLength:function(t,e){var n=get_val(t);return(""!==n||is_required(t))&&n.length<e.data?!1:!0},email:function(t,e){var n=get_val(t);return""!==n||is_required(t)?vd.isEmail(n):!0},noSpecialChars:function(t){var e=get_val(t);return e&&/[^0-9a-zzA-Z_\-]/.test(e)?!1:!0},password:function(t,e){var n=get_val(t);return""!==n||is_required(t)?n.length>=6:!0},equalTo:function(t,e){var n=get_val(t);return""!==n||is_required(t)?$(e.data).val()==n:!0}};rule_funcs=rule_funcs||{},rule_funcs=$.extend(default_rule_funcs,rule_funcs);var rules={},msg_targets={},$allElems=$(form).find("[data-rules]"),$form=$(form);$form.on({keyup:function(t){13!=t.keyCode&&focus_func(t)},blur:unfocus_func},'input[type="text"], input[type="password"]'),$form.on({change:function(t){$(this).val()?focus_func(t):unfocus_func(t)}},"select"),$form.on({change:function(t){unfocus_func(t)}},'input[type="checkbox"]'),this.valid=function(){for(var t=$allElems,e=!0,n=0;n<t.length;++n){var o=t.eq(n),r=get_name(o);if(!apply_rules(o,r))return e=!1,o.focus(),!1}return e},this.validElement=function(t){for(var t=$(t),e=!0,n=0;n<t.length;++n){var o=t.eq(n),r=get_name(o);apply_rules(o,r)||(e=!1)}return e}}},trimTitle=function(t){return t&&"string"==typeof t?t.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""};
Note.curNoteId="",Note.interval="",Note.itemIsBlog='<div class="item-blog"><i class="fa fa-bold" title="blog"></i></div><div class="item-setting"><i class="fa fa-cog" title="setting"></i></div>',Note.itemTplNoImg='<li href="#" class="item ?" noteId="?">',Note.itemTplNoImg+=Note.itemIsBlog+'<div class="item-desc"><p class="item-title">?</p><p class="item-info"><i class="fa fa-book"></i> <span class="note-notebook">?</span> <i class="fa fa-clock-o"></i> <span class="updated-time">?</span></p><p class="desc">?</p></div></li>',Note.itemTpl='<li href="#" class="item ? item-image" noteId="?"><div class="item-thumb" style=""><img src="?"/></div>',Note.itemTpl+=Note.itemIsBlog+'<div class="item-desc" style=""><p class="item-title">?</p><p class="item-info"><i class="fa fa-book"></i> <span class="note-notebook">?</span> <i class="fa fa-clock-o"></i> <span class="updated-time">?</span></p><p class="desc">?</p></div></li>',Note.newItemTpl='<li href="#" class="item item-active ?" fromUserId="?" noteId="?">',Note.newItemTpl+=Note.itemIsBlog+'<div class="item-desc" style="right: 0px;"><p class="item-title">?</p><p class="item-text"><i class="fa fa-book"></i> <span class="note-notebook">?</span> <i class="fa fa-clock-o"></i> <span class="updated-time">?</span><br /><span class="desc">?</span></p></div></li>',Note.noteItemListO=$("#noteItemList"),Note.cacheByNotebookId={all:{}},Note.notebookIds={},Note.isReadOnly=!1,Note.intervalTime=6e5,Note.startInterval=function(){Note.interval=setInterval(function(){log("自动保存开始..."),changedNote=Note.curChangedSaveIt(!1)},Note.intervalTime)},Note.stopInterval=function(){clearInterval(Note.interval),setTimeout(function(){Note.startInterval()},Note.intervalTime)},Note.addNoteCache=function(t){Note.cache[t.NoteId]=t,Note.clearCacheByNotebookId(t.NotebookId)},Note.setNoteCache=function(t,e){Note.cache[t.NoteId]?$.extend(Note.cache[t.NoteId],t):Note.cache[t.NoteId]=t,void 0==e&&(e=!0),e&&Note.clearCacheByNotebookId(t.NotebookId)},Note.getCurNote=function(){var t=this;return""==t.curNoteId?null:t.cache[t.curNoteId]},Note.getNote=function(t){var e=this;return e.cache[t]},Note.clearCacheByNotebookId=function(t){t&&(Note.cacheByNotebookId[t]={},Note.cacheByNotebookId.all={},Note.notebookIds[t]=!0)},Note.notebookHasNotes=function(t){var e=Note.getNotesByNotebookId(t);return!isEmpty(e)},Note.getNotesByNotebookId=function(t,e,o){if(e||(e="UpdatedTime"),"undefined"==o&&(o=!1),t||(t="all"),!Note.cacheByNotebookId[t])return[];if(Note.cacheByNotebookId[t][e])return Note.cacheByNotebookId[t][e];var a=[];for(var n in Note.cache)if(n){var i=Note.cache[n];i.IsTrash||i.IsShared||("all"==t||i.NotebookId==t)&&a.push(i)}return a.sort(function(t,a){var n=t[e],i=a[e];if(o){if(i>n)return-1;if(n>i)return 1}else{if(i>n)return 1;if(n>i)return-1}return 0}),Note.cacheByNotebookId[t][e]=a,a},Note.curNoteIsDirtied=function(){var t=this,e=t.getCurNote();e&&(e.isDirty=!0)},Note.renderNotesAndFirstOneContent=function(t){isArray(t)&&(Note.renderNotes(t),isEmpty(t[0])||Note.changeNoteForPjax(t[0].NoteId,!0,!1))},Note.curHasChanged=function(t){void 0==t&&(t=!0);var e,o,a,n=Note.cache[Note.curNoteId]||{},i=$("#noteTitle").val(),s=Tag.getTags(),r=getEditorContent(n.IsMarkdown);if(isArray(r))e=r[0],o=r[1],a=e,e&&previewIsEmpty(o)&&Converter&&(o=Converter.makeHtml(e)),e||(o=""),n.Preview=o;else{e=r;try{a=$(e).text()}catch(c){}}var d={hasChanged:!1,IsNew:n.IsNew,IsMarkdown:n.IsMarkdown,FromUserId:n.FromUserId,NoteId:n.NoteId,NotebookId:n.NotebookId,Version:n.Version||0};if(d.IsNew)$.extend(d,n);else if(!n.isDirty)return log("no dirty"),d.hasChanged=!1,d;if(n.Title!=i&&(d.hasChanged=!0,d.Title=i,!d.Title),arrayEqual(n.Tags,s)||(d.hasChanged=!0,d.Tags=s.join(",")),t&&n.Content!=e||!t&&(!n.IsMarkdown&&$(n.Content).text()!=a||n.IsMarkdown&&n.Content!=a)){d.hasChanged=!0,d.Content=e;var l=o||e;n.HasSelfDefined&&n.IsBlog||(d.Desc=Note.genDesc(l),d.ImgSrc=Note.getImgSrc(l),d.Abstract=Note.genAbstract(l))}else log("text相同"),log(n.Content==e);return d.UserId=n.UserId||"",d},Note.genDesc=function(t){return t?(t=t.replace(/<br \/>/g," <br />"),t=t.replace(/<\/p>/g," </p>"),t=t.replace(/<\/div>/g," </div>"),t=$("<div></div>").html(t).text(),t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),t.length<300?t:t.substring(0,300)):""},Note.genAbstract=function(t,e){if(!t)return"";if(void 0==e&&(e=1e3),t.length<e)return t;for(var o=!1,a=!1,n=0,i="",s=e,r=0;r<t.length;++r){var c=t[r];if("<"==c?o=!0:"&"==c?a=!0:">"==c&&o?(n-=1,o=!1):";"==c&&a&&(a=!1),o||a||(n+=1),i+=c,n>=s)break}var d=document.createElement("div");return d.innerHTML=i,d.innerHTML},Note.getImgSrc=function(t){if(!t)return"";var e=$(t).find("img");for(var o in e){var a=e.eq(o).attr("src");if(a)return a}return""},Note.saveInProcess={},Note.savePool={},Note.curChangedSaveIt=function(t,e){var o=this;if(Note.curNoteId&&!Note.isReadOnly){var a=Note.curHasChanged(t);return a.hasChanged||a.IsNew?(Note.renderChangedNote(a),delete a.hasChanged,showMsg(getMsg("saving")),o.saveInProcess[a.NoteId]=!0,ajaxPost("/note/updateNoteOrContent",a,function(t){o.saveInProcess[a.NoteId]=!1,a.IsNew&&(t.IsNew=!1,Note.setNoteCache(t,!1),Pjax.changeNote(t)),e&&e(),showMsg(getMsg("saveSuccess"),1e3)}),void 0!=a.Tags&&"string"==typeof a.Tags&&(a.Tags=a.Tags.split(",")),Note.setNoteCache(a,!1),Note.setNoteCache({NoteId:a.NoteId,UpdatedTime:(new Date).format("yyyy-MM-ddThh:mm:ss.S")},!1),a):!1}},Note.updatePoolNote=function(){var t=this;for(var e in t.savePool)if(e){delete t.savePool[e];var o=t.savePool[e];t.saveInProcess[e]=!0,ajaxPost("/note/updateNoteOrContent",o,function(o){t.saveInProcess[e]=!1})}},Note.updatePoolNoteInterval=null,Note.startUpdatePoolNoteInterval=function(){return},Note.selectTarget=function(t){$(".item").removeClass("item-active"),$(t).addClass("item-active")},Note.showContentLoading=function(){$("#noteMaskForLoading").css("z-index",99999)},Note.hideContentLoading=function(){$("#noteMaskForLoading").css("z-index",-1)},Note.directToNote=function(t){var e=$("#noteItemList"),o=e.height(),a=$("[noteId='"+t+"']").position().top,n=e.scrollTop();if(a+=n,a>=n&&o+n>=a);else{var i=a;log("定位到特定note, 在可视范围内"),LEA.isMobile||Mobile.isMobile()||($("#noteItemList").scrollTop(i),$("#noteItemList").slimScroll({scrollTo:i+"px",height:"100%",onlyScrollBar:!0}))}},Note.changeNoteForPjax=function(t,e,o){var a=this,n=a.getNote(t);if(n){var i=void 0!=n.Perm;void 0==o&&(o=!0),a.changeNote(t,i,!0,function(a){void 0==e&&(e=!0),e&&Pjax.changeNote(a),o&&Note.directToNote(t)}),o&&(i?$("#myShareNotebooks").hasClass("closed")&&$("#myShareNotebooks .folderHeader").trigger("click"):$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click"),Notebook.expandNotebookTo(n.NotebookId))}},Note.contentAjax=null,Note.contentAjaxSeq=1,Note.changeNote=function(t,e,o,a){function n(e){Note.contentAjax=null,d==Note.contentAjaxSeq&&(Note.setNoteCache(e,!1),e=Note.cache[t],Note.renderNoteContent(e),i.hideContentLoading(),a&&a(e))}var i=this;Note.stopInterval();var s=$(tt('[noteId="?"]',t));if(Note.selectTarget(s),void 0==o&&(o=!0),o){Note.curChangedSaveIt()}Note.curNoteId="";var r=Note.cache[t];e||void 0!=r.Perm&&(e=!0);var c=!e||Share.hasUpdatePerm(t);c?(Note.hideReadOnly(),Note.renderNote(r)):Note.renderNoteReadOnly(r),switchEditor(r.IsMarkdown),Attach.renderNoteAttachNum(t,!0),Note.contentAjaxSeq++;var d=Note.contentAjaxSeq;if(r.Content)return void n(r);var l="/note/getNoteContent",N={noteId:t};e&&(l="/share/getShareNoteContent",N.sharedUserId=r.UserId),i.showContentLoading(),null!=Note.contentAjax&&Note.contentAjax.abort(),Note.contentAjax=ajaxGet(l,N,n)},Note.renderChangedNote=function(t){if(t){var e=$(tt('[noteId="?"]',t.NoteId));t.Title&&e.find(".item-title").html(trimTitle(t.Title)),t.Desc&&e.find(".desc").html(t.Desc),t.ImgSrc?($thumb=e.find(".item-thumb"),$thumb.length>0?$thumb.find("img").attr("src",t.ImgSrc):(e.append(tt('<div class="item-thumb" style=""><img src="?"></div>',t.ImgSrc)),e.addClass("item-image")),e.find(".item-desc").removeAttr("style")):""==t.ImgSrc&&(e.find(".item-thumb").remove(),e.removeClass("item-image"))}},Note.clearNoteInfo=function(){Note.curNoteId="",Tag.clearTags(),$("#noteTitle").val(""),setEditorContent(""),$("#noteRead").hide()},Note.clearNoteList=function(){Note.noteItemListO.html("")},Note.clearAll=function(){Note.curNoteId="",Note.clearNoteInfo(),Note.clearNoteList()},Note.renderNote=function(t){t&&($("#noteTitle").val(t.Title),Tag.renderTags(t.Tags),t.isDirty=!1)},Note.renderNoteContent=function(t){setEditorContent(t.Content,t.IsMarkdown,t.Preview,function(){Note.curNoteId=t.NoteId,Note.toggleReadOnly()}),Note.curNoteId=t.NoteId},Note.showEditorMask=function(){$("#editorMask").css("z-index",10).show(),Notebook.curNotebookIsTrashOrAll()?($("#editorMaskBtns").hide(),$("#editorMaskBtnsEmpty").show()):($("#editorMaskBtns").show(),$("#editorMaskBtnsEmpty").hide())},Note.hideEditorMask=function(){$("#editorMask").css("z-index",-10).hide()},Note.renderNotesC=0,Note.renderNotes=function(t,e,o){var a=++Note.renderNotesC;if(LEA.isMobile||Mobile.isMobile()||$("#noteItemList").slimScroll({scrollTo:"0px",height:"100%",onlyScrollBar:!0}),!t||"object"!=typeof t||t.length<=0)return void(e||Note.showEditorMask());Note.hideEditorMask(),void 0==e&&(e=!1),e||Note.noteItemListO.html("");var n=t.length,i=Math.ceil(n/20);Note._renderNotes(t,e,o,1);for(var s=0;n>s;++s){var r=t[s];Note.setNoteCache(r,!1),o&&Share.setCache(r)}for(var s=1;i>s;++s)setTimeout(function(n){return function(){a==Note.renderNotesC&&Note._renderNotes(t,e,o,n+1)}}(s),2e3*s)},Note._renderNotes=function(t,e,o,a){var n="item-my";o&&(n="item-shared");for(var i=t.length,s=20*(a-1);i>s&&20*a>s;++s){var r=n;e||0!=s||(r+=" item-active");var c,d=t[s];d.Title=trimTitle(d.Title),c=d.ImgSrc?tt(Note.itemTpl,r,d.NoteId,d.ImgSrc,d.Title,Notebook.getNotebookTitle(d.NotebookId),goNowToDatetime(d.UpdatedTime),d.Desc):tt(Note.itemTplNoImg,r,d.NoteId,d.Title,Notebook.getNotebookTitle(d.NotebookId),goNowToDatetime(d.UpdatedTime),d.Desc),d.IsBlog||(c=$(c),c.find(".item-blog").hide()),Note.noteItemListO.append(c)}},Note.newNote=function(t,e,o,a){switchEditor(a),Note.hideEditorMask(),Note.hideReadOnly(),Note.stopInterval(),Note.curChangedSaveIt();var n={NoteId:getObjectId(),Title:"",Tags:[],Content:"",NotebookId:t,IsNew:!0,FromUserId:o,IsMarkdown:a};Note.addNoteCache(n),Attach.clearNoteAttachNum();var i="",s="item-my";e&&(s="item-shared");var r=Notebook.getNotebook(t),c=r?r.Title:"",d=getCurDate();i=e?tt(Note.newItemTpl,s,o,n.NoteId,n.Title,c,d,""):tt(Note.newItemTpl,s,"",n.NoteId,n.Title,c,d,""),r.IsBlog||(i=$(i),i.find(".item-blog").hide()),Notebook.isCurNotebook(t)?Note.noteItemListO.prepend(i):(Note.clearAll(),Note.noteItemListO.prepend(i),e?Share.changeNotebookForNewNote(t):Notebook.changeNotebookForNewNote(t)),Note.selectTarget($(tt('[noteId="?"]',n.NoteId))),$("#noteTitle").focus(),Note.renderNote(n),Note.renderNoteContent(n),Note.curNoteId=n.NoteId,Notebook.incrNotebookNumberNotes(t),Note.toggleWriteable()},Note.saveNote=function(t){var e=t.which?t.which:t.keyCode;return(t.ctrlKey||t.metaKey)&&83==e?(Note.curChangedSaveIt(),t.preventDefault(),!1):void 0},Note.changeToNext=function(t){var e=$(t),o=e.next();if(!o.length){var a=e.prev();if(!a.length)return void Note.showEditorMask();o=a}Note.changeNote(o.attr("noteId"))},Note.deleteNote=function(t,e,o){if($(t).hasClass("item-active")&&(Note.stopInterval(),Note.curNoteId=null,Note.clearNoteInfo()),noteId=$(t).attr("noteId"),noteId){$(t).hide();var a=Note.cache[noteId],n="/note/deleteNote";a.IsTrash?n="/note/deleteTrash":Notebook.minusNotebookNumberNotes(a.NotebookId),ajaxGet(n,{noteId:noteId,userId:a.UserId,isShared:o},function(e){e?(Note.changeToNext(t),$(t).remove(),a&&(Note.clearCacheByNotebookId(a.NotebookId),delete Note.cache[noteId]),showMsg("删除成功!",500)):($(t).show(),showMsg("删除失败!",2e3))})}},Note.listNoteShareUserInfo=function(t){var e=$(t).attr("noteId");showDialogRemote("/share/listNoteShareUserInfo",{noteId:e})},Note.shareNote=function(t){var e=$(t).find(".item-title").text();showDialog("dialogShareNote",{title:getMsg("shareToFriends")+"-"+e}),setTimeout(function(){$("#friendsEmail").focus()},500);var o=$(t).attr("noteId");shareNoteOrNotebook(o,!0)},Note.listNoteContentHistories=function(){$("#leanoteDialog #modalTitle").html(getMsg("history")),$content=$("#leanoteDialog .modal-body"),$content.html(""),$("#leanoteDialog .modal-footer").html('<button type="button" class="btn btn-default" data-dismiss="modal">'+getMsg("close")+"</button>"),options={},options.show=!0,$("#leanoteDialog").modal(options),ajaxGet("/noteContentHistory/listHistories",{noteId:Note.curNoteId},function(t){if(!isArray(t))return void $content.html(getMsg("noHistories"));var e="<p>"+getMsg("historiesNum")+'</p><div id="historyList"><table class="table table-hover">';note=Note.cache[Note.curNoteId];var o="div";note.IsMarkdown&&(o="pre");for(i in t){var a=t[i];a.Ab=Note.genAbstract(a.Content,200),e+='<tr><td seq="'+i+'">#'+(i+1)+"<"+o+' class="each-content">'+a.Ab+"</"+o+'> <div class="btns">'+getMsg("datetime")+': <span class="label label-default">'+goNowToDatetime(a.UpdatedTime)+'</span> <button class="btn btn-default all">'+getMsg("unfold")+'</button> <button class="btn btn-primary back">'+getMsg("restoreFromThisVersion")+"</button></div></td></tr>"}e+="</table></div>",$content.html(e),$("#historyList .all").click(function(){$p=$(this).parent().parent();var e=$p.attr("seq"),o=$p.find(".each-content"),a=t[e];a.unfold?($(this).text(getMsg("unfold")),o.html(a.Ab),a.unfold=!1):($(this).text(getMsg("fold")),o.html(a.Content),a.unfold=!0)}),$("#historyList .back").click(function(){$p=$(this).parent().parent();var e=$p.attr("seq");confirm(getMsg("confirmBackup"))&&(Note.curChangedSaveIt(),note=Note.cache[Note.curNoteId],setEditorContent(t[e].Content,note.IsMarkdown),hideDialog())})})},Note.showReadOnly=function(){Note.isReadOnly=!0,$("#note").addClass("read-only")},Note.hideReadOnly=function(){Note.isReadOnly=!1,$("#note").removeClass("read-only"),$("#noteRead").hide()},Note.renderNoteReadOnly=function(t){Note.showReadOnly(),$("#noteReadTitle").html(t.Title||getMsg("unTitled")),Tag.renderReadOnlyTags(t.Tags),$("#noteReadCreatedTime").html(goNowToDatetime(t.CreatedTime)),$("#noteReadUpdatedTime").html(goNowToDatetime(t.UpdatedTime))},Note.renderNoteContentReadOnly=function(t){},Note.lastSearch=null,Note.lastKey=null,Note.lastSearchTime=new Date,Note.isOver2Seconds=!1,Note.isSameSearch=function(t){var e=new Date,o=e.getTime()-Note.lastSearchTime.getTime();return Note.isOver2Seconds=o>2e3?!0:!1,!Note.lastKey||Note.lastKey!=t||o>1e3?(Note.lastKey=t,Note.lastSearchTime=e,!1):t==Note.lastKey?!0:(Note.lastSearchTime=e,Note.lastKey=t,!1)},Note.searchNote=function(){var t=$("#searchNoteInput").val();return t?void(Note.isSameSearch(t)||(Note.lastSearch&&Note.lastSearch.abort(),Note.curChangedSaveIt(),Note.clearAll(),showLoading(),Note.lastSearch=$.post("/note/searchNote",{key:t},function(t){hideLoading(),t&&(Note.lastSearch=null,Note.renderNotes(t),isEmpty(t)||Note.changeNote(t[0].NoteId,!1))}))):void Notebook.changeNotebook("0")},Note.setNote2Blog=function(t){var e=$(t).attr("noteId"),o=Note.cache[e],a=!0;void 0!=o.IsBlog&&(a=!o.IsBlog),a?$(t).find(".item-blog").show():$(t).find(".item-blog").hide(),ajaxPost("/note/setNote2Blog",{noteId:e,isBlog:a},function(t){t&&Note.setNoteCache({NoteId:e,IsBlog:a},!1)})},Note.setAllNoteBlogStatus=function(t,e){if(t){var o=Note.getNotesByNotebookId(t);if(isArray(o)){var a=o.length;if(0==a)for(var n in Note.cache)Note.cache[n].NotebookId==t&&(Note.cache[n].IsBlog=e);else for(var n=0;a>n;++n)o[n].IsBlog=e}}},Note.moveNote=function(t,e){var o=$(t).attr("noteId"),a=Note.cache[o],n=e.notebookId;(a.IsTrash||a.NotebookId!=n)&&(Notebook.incrNotebookNumberNotes(n),a.IsTrash||Notebook.minusNotebookNumberNotes(a.NotebookId),ajaxGet("/note/moveNote",{noteId:o,notebookId:n},function(e){e&&e.NoteId&&(a.IsTrash?(Note.changeToNext(t),$(t).remove(),Note.clearCacheByNotebookId(n)):(Notebook.curActiveNotebookIsAll()?$(t).find(".note-notebook").html(Notebook.getNotebookTitle(n)):(Note.changeToNext(t),$(t).hasClass("item-active")&&Note.clearNoteInfo(),$(t).remove()),Note.clearCacheByNotebookId(a.NotebookId),Note.clearCacheByNotebookId(n)),Note.setNoteCache(e))}))},Note.copyNote=function(t,e,o){var a=$(t).attr("noteId"),n=Note.cache[a],i=e.notebookId;if(!n.IsTrash&&n.NotebookId!=i){var s="/note/copyNote",e={noteId:a,notebookId:i};o&&(s="/note/copySharedNote",e.fromUserId=n.UserId),ajaxGet(s,e,function(t){t&&t.NoteId&&(Note.clearCacheByNotebookId(i),Note.setNoteCache(t))}),Notebook.incrNotebookNumberNotes(i)}},Note.deleteNoteTag=function(t,e){if(t)for(var o in t){var a=Note.getNote(o);if(a){a.Tags=a.Tags||[];for(var n in a.Tags)a.Tags[n]!=e||a.Tags.splice(n,1);o==Note.curNoteId&&Tag.renderTags(a.Tags)}}},Note.readOnly=!1,Note.toggleReadOnly=function(){if(LEA.em&&LEA.em.isWriting())return Note.toggleWriteable();var t=this,e=t.getCurNote();$("#editorContent").attr("contenteditable",!1),$("#mdEditor").addClass("read-only"),e&&($(".info-toolbar").removeClass("invisible"),e.IsMarkdown?($("#mdInfoToolbar .created-time").html(goNowToDatetime(e.CreatedTime)),$("#mdInfoToolbar .updated-time").html(goNowToDatetime(e.UpdatedTime))):($("#infoToolbar .created-time").html(goNowToDatetime(e.CreatedTime)),$("#infoToolbar .updated-time").html(goNowToDatetime(e.UpdatedTime))),e.readOnly||(e.IsMarkdown||$("#editorContent pre").each(function(){LeaAce.setAceReadOnly($(this),!0)}),e.readOnly=!0,Note.readOnly=!0))},Note.toggleWriteable=function(){var t=this;$("#editor").removeClass("read-only"),$("#editorContent").attr("contenteditable",!0),$("#mdEditor").removeClass("read-only");var e=t.getCurNote();e&&e.readOnly&&(e.IsMarkdown?MD&&MD.onResize():$("#editorContent pre").each(function(){LeaAce.setAceReadOnly($(this),!1)}),e.readOnly=!1,Note.readOnly=!1)},Note.getContextNotebooks=function(t){var e=[],o=[],a=[];for(var n in t){var i=t[n],s={text:i.Title,notebookId:i.NotebookId,action:Note.moveNote},r={text:i.Title,notebookId:i.NotebookId,action:Note.copyNote},c={text:i.Title,notebookId:i.NotebookId,action:Share.copySharedNote};if(!isEmpty(i.Subs)){var d=Note.getContextNotebooks(i.Subs);s.items=d[0],r.items=d[1],c.items=d[2],s.type="group",s.width=150,r.type="group",r.width=150,c.type="group",c.width=150}e.push(s),o.push(r),a.push(c)}return[e,o,a]},Note.contextmenu=null,Note.notebooksCopy=[],Note.initContextmenu=function(){function t(t){var e=$(this).attr("noteId"),o=Note.cache[e];if(o){var a=[];if(o.IsTrash)a.push("shareToFriends"),a.push("shareStatus"),a.push("unset2Blog"),a.push("set2Blog"),a.push("copy");else{o.IsBlog?a.push("set2Blog"):a.push("unset2Blog");var n=Notebook.getNotebookTitle(o.NotebookId);a.push("move."+n),a.push("copy."+n)}t.applyrule({name:"target..",disable:!0,items:a})}}function e(){return"target3"!=this.id}var o=Note;Note.contextmenu&&Note.contextmenu.destroy();var a=Notebook.everNotebooks,n=o.getContextNotebooks(a),i=n[0],s=n[1];o.notebooksCopy=n[2];var r={width:180,items:[{text:getMsg("shareToFriends"),alias:"shareToFriends",icon:"",faIcon:"fa-share-square-o",action:Note.listNoteShareUserInfo},{type:"splitLine"},{text:getMsg("publicAsBlog"),alias:"set2Blog",faIcon:"fa-bold",action:Note.setNote2Blog},{text:getMsg("cancelPublic"),alias:"unset2Blog",faIcon:"fa-undo",action:Note.setNote2Blog},{type:"splitLine"},{text:getMsg("delete"),icon:"",faIcon:"fa-trash-o",action:Note.deleteNote},{text:getMsg("move"),alias:"move",faIcon:"fa-arrow-right",type:"group",width:180,items:i},{text:getMsg("copy"),alias:"copy",icon:"",faIcon:"fa-copy",type:"group",width:180,items:s}],onShow:t,onContextMenu:e,parent:"#noteItemList",children:".item-my"};Note.contextmenu=$("#noteItemList .item-my").contextmenu(r)};var Attach={loadedNoteAttachs:{},attachsMap:{},init:function(){var t=this;$("#showAttach").click(function(){t.renderAttachs(Note.curNoteId)}),t.attachListO.click(function(t){t.stopPropagation()}),t.attachListO.on("click",".delete-attach",function(e){e.stopPropagation();var o=$(this).closest("li").data("id"),a=this;confirm("Are you sure to delete it ?")&&($(a).button("loading"),ajaxPost("/attach/deleteAttach",{attachId:o},function(e){$(a).button("reset"),reIsOk(e)?t.deleteAttach(o):alert(e.Msg)}))}),t.attachListO.on("click",".download-attach",function(t){t.stopPropagation();var e=$(this).closest("li").data("id");window.open(UrlPrefix+"/attach/download?attachId="+e)}),t.downloadAllBtnO.click(function(){window.open(UrlPrefix+"/attach/downloadAll?noteId="+Note.curNoteId)}),t.attachListO.on("click",".link-attach",function(e){e.stopPropagation();var o=$(this).closest("li").data("id"),a=t.attachsMap[o],n=UrlPrefix+"/attach/download?attachId="+o;LEA.isMarkdownEditor()&&MD&&MD.insertLink(n,a.Title)}),t.linkAllBtnO.on("click",function(t){t.stopPropagation();var e=Note.getCurNote();if(e){var o=UrlPrefix+"/attach/downloadAll?noteId="+Note.curNoteId,a=e.Title?e.Title+".tar.gz":"all.tar.gz";LEA.isMarkdownEditor()&&MD&&MD.insertLink(o,a)}})},attachListO:$("#attachList"),attachNumO:$("#attachNum"),attachDropdownO:$("#attachDropdown"),downloadAllBtnO:$("#downloadAllBtn"),linkAllBtnO:$("#linkAllBtn"),clearNoteAttachNum:function(){var t=this;t.attachNumO.html("").hide()},renderNoteAttachNum:function(t,e){var o=this,a=Note.getNote(t);a.AttachNum?(o.attachNumO.html("("+a.AttachNum+")").show(),o.downloadAllBtnO.show(),o.linkAllBtnO.show()):(o.attachNumO.hide(),o.downloadAllBtnO.hide(),o.linkAllBtnO.hide()),e&&o.attachDropdownO.removeClass("open")},_renderAttachs:function(t){for(var e=this,o="",a=t.length,n=0;a>n;++n){var i=t[n];o+='<li class="clearfix" data-id="'+i.AttachId+'"><div class="attach-title">'+i.Title+'</div><div class="attach-process"> 	  <button class="btn btn-sm btn-warning delete-attach" data-loading-text="..."><i class="fa fa-trash-o"></i></button> 	  <button type="button" class="btn btn-sm btn-primary download-attach"><i class="fa fa-download"></i></button> 	  <button type="button" class="btn btn-sm btn-default link-attach" title="Insert link into content"><i class="fa fa-link"></i></button> </div></li>',e.attachsMap[i.AttachId]=i}e.attachListO.html(o);var s=Note.getCurNote();s&&(s.AttachNum=a,e.renderNoteAttachNum(s.NoteId,!1))},_bookmark:null,renderAttachs:function(t){var e=this;return e.loadedNoteAttachs[t]?void e._renderAttachs(e.loadedNoteAttachs[t]):(e.attachListO.html('<li class="loading"><img src="/images/loading-24.gif"/></li>'),void ajaxGet("/attach/getAttachs",{noteId:t},function(o){var a=[];o.Ok&&(a=o.List,a||(a=[])),e.loadedNoteAttachs[t]=a,e._renderAttachs(a)}))},addAttach:function(t){var e=this;e.loadedNoteAttachs[t.NoteId]||(e.loadedNoteAttachs[t.NoteId]=[]),e.loadedNoteAttachs[t.NoteId].push(t),e.renderAttachs(t.NoteId)},deleteAttach:function(t){for(var e=this,o=Note.curNoteId,a=e.loadedNoteAttachs[o],n=0;n<a.length;++n)if(a[n].AttachId==t){a.splice(n,1);break}e.renderAttachs(o)},downloadAttach:function(t){},downloadAll:function(){}};$(function(){Attach.init(),$("#noteItemList").on("mouseenter",".item",function(t){(LEA.isIpad||LEA.isIphone)&&$(this).trigger("click")}),$("#noteItemList").on("click",".item",function(t){t.stopPropagation();var e=$(this).attr("noteId");Mobile.changeNote(e),e&&Note.curNoteId!=e&&Note.changeNoteForPjax(e,!0,!1)}),$("#editorContent, #wmd-input, #noteTitle").on("keyup input",function(){Note.curNoteIsDirtied()}),$("#newNoteBtn, #editorMask .note").click(function(){var t=$("#curNotebookForNewNote").attr("notebookId");Note.newNote(t)}),$("#newNoteMarkdownBtn, #editorMask .markdown").click(function(){var t=$("#curNotebookForNewNote").attr("notebookId");Note.newNote(t,!1,"",!0)}),$("#notebookNavForNewNote").on("click","li div",function(){var t=$(this).attr("notebookId");$(this).hasClass("new-note-right")?Note.newNote(t,!1,"",!0):Note.newNote(t)}),$("#searchNotebookForAdd").click(function(t){t.stopPropagation()}),$("#searchNotebookForAdd").keyup(function(){var t=$(this).val();Notebook.searchNotebookForAddNote(t)}),$("#searchNotebookForList").keyup(function(){var t=$(this).val();Notebook.searchNotebookForList(t)}),$("#searchNoteInput").on("keydown",function(t){var e=t;return 13==e.keyCode||108==e.keyCode?(e.preventDefault(),Note.searchNote(),!1):void 0}),$("#contentHistory").click(function(){Note.listNoteContentHistories()}),$("#saveBtn").click(function(){Note.curChangedSaveIt(!0)}),$("#noteItemList").on("click",".item-blog",function(t){t.preventDefault(),t.stopPropagation();var e=$(this).parent().attr("noteId");window.open("/p/"+e)}),$("#noteItemList").on("click",".item-my .item-setting",function(t){t.preventDefault(),t.stopPropagation();var e=$(this).parent();Note.contextmenu.showMenu(t,e)}),$(".toolbar-update").click(function(){Note.toggleWriteable()})}),Note.startInterval();
function editorMode(){this.writingHash="writing",this.normalHash="normal",this.isWritingMode=location.hash.indexOf(this.writingHash)>=0,this.toggleA=null}function initSlimScroll(){Mobile.isMobile()||($("#notebook").slimScroll({height:"100%"}),$("#noteItemList").slimScroll({height:"100%"}),$("#wmd-panel-preview").slimScroll({height:"100%"}),$("#wmd-panel-preview").css("width","100%"))}function initEditor(){$("#moreBtn").click(function(){saveBookmark();var e=$("#editor");e.hasClass("all-tool")?e.removeClass("all-tool"):e.addClass("all-tool"),restoreBookmark()}),window.onbeforeunload=function(e){Note.curChangedSaveIt()},$("body").on("keydown",Note.saveNote)}function scrollTo(e,t,o){var i=$("#editorContent"),n=i.find(t+":contains("+o+")");random++;for(var s=$('#leanoteNavContent [data-a="'+t+"-"+encodeURI(o)+'"]'),r=s.size(),a=0;r>a&&s[a]!=e;++a);if(n.size()>=a+1){n=n.eq(a);var d=i.scrollTop()-i.offset().top+n.offset().top;return void i.animate({scrollTop:d},300)}}function openSetInfoDialog(e){showDialogRemote("/user/account",{tab:e})}function updateLeftIsMin(e){ajaxGet("/user/updateLeftIsMin",{leftIsMin:e})}function minLeft(e){$("#leftNotebook").width(30),$("#notebook").hide(),$("#noteAndEditor").css("left",30),$("#notebookSplitter").hide(),$("#logo").hide(),$("#leftSwitcher").hide(),$("#leftSwitcher2").show(),$("#leftNotebook .slimScrollDiv").hide(),e&&updateLeftIsMin(!0)}function maxLeft(e){$("#noteAndEditor").css("left",UserInfo.NotebookWidth),$("#leftNotebook").width(UserInfo.NotebookWidth),$("#notebook").show(),$("#notebookSplitter").show(),$("#leftSwitcher2").hide(),$("#logo").show(),$("#leftSwitcher").show(),$("#leftNotebook .slimScrollDiv").show(),e&&updateLeftIsMin(!1)}function getMaxDropdownHeight(e){var t=$(e).offset(),o=$(document).height()-t.top;o-=70,0>o&&(o=0);var i=$(e).find("ul").height();return o>i?i:o}function initPage(){if(Notebook.renderNotebooks(notebooks),Share.renderShareNotebooks(sharedUserInfos,shareNotebooks),curSharedNoteNotebookId?Share.firstRenderShareNote(curSharedUserId,curSharedNoteNotebookId,curNoteId):(Note.setNoteCache(noteContentJson),Note.renderNotes(notes),curNoteId&&(setTimeout(function(){Note.changeNoteForPjax(curNoteId,!0,curNotebookId)}),curNotebookId||Notebook.selectNotebook($(tt('#notebook [notebookId="?"]',Notebook.allNotebookId))))),latestNotes.length>0)for(var e=0;e<latestNotes.length;++e)Note.addNoteCache(latestNotes[e]);Tag.renderTagNav(tagsJson),initSlimScroll()}editorMode.prototype.toggleAText=function(e){var t=this;setTimeout(function(){var o=$(".toggle-editor-mode a"),i=$(".toggle-editor-mode span");e?(o.attr("href","#"+t.normalHash),i.text(getMsg("normalMode"))):(o.attr("href","#"+t.writingHash),i.text(getMsg("writingMode")))},0)},editorMode.prototype.isWriting=function(e){return e||(e=location.hash),e.indexOf(this.writingHash)>=0},editorMode.prototype.init=function(){this.$themeLink=$("#themeLink"),this.changeMode(this.isWritingMode);var e=this;$(".toggle-editor-mode").click(function(t){t.preventDefault(),saveBookmark();var o=$(this).find("a"),i=e.isWriting(o.attr("href"));e.changeMode(i),i?setHash("m",e.writingHash):setHash("m",e.normalHash),restoreBookmark()})},editorMode.prototype.changeMode=function(e){this.toggleAText(e),e?this.writtingMode():this.normalMode()},editorMode.prototype.resizeEditor=function(){setTimeout(function(){resizeEditor()},10),setTimeout(function(){resizeEditor()},20),setTimeout(function(){resizeEditor()},500)},editorMode.prototype.normalMode=function(){$("#noteItemListWrap, #notesAndSort").show(),$("#noteList").unbind("mouseenter").unbind("mouseleave");var e=UserInfo.Theme||"default";e+=".css";$("#themeLink");-1!=this.$themeLink.attr("href").indexOf("writting-overwrite.css")&&this.$themeLink.attr("href","/css/theme/"+e),$("#noteList").width(UserInfo.NoteListWidth),$("#note").css("left",UserInfo.NoteListWidth)},editorMode.prototype.writtingMode=function(){-1==this.$themeLink.attr("href").indexOf("writting-overwrite.css")&&this.$themeLink.attr("href","/css/theme/writting-overwrite.css"),$("#noteItemListWrap, #notesAndSort").fadeOut(),$("#noteList").hover(function(){$("#noteItemListWrap, #notesAndSort").fadeIn()},function(){$("#noteItemListWrap, #notesAndSort").fadeOut()}),this.resizeEditor(),$("#noteList").width(250),$("#note").css("left",0),Note.toggleWriteable()},editorMode.prototype.getWritingCss=function(){return this.isWritingMode?["/css/editor/editor-writting-mode.css"]:[]};var em=new editorMode;LEA.em=em;var Resize={lineMove:!1,mdLineMove:!1,target:null,leftNotebook:$("#leftNotebook"),notebookSplitter:$("#notebookSplitter"),noteList:$("#noteList"),noteAndEditor:$("#noteAndEditor"),noteSplitter:$("#noteSplitter"),note:$("#note"),body:$("body"),leftColumn:$("#left-column"),rightColumn:$("#right-column"),mdSplitter:$("#mdSplitter2"),init:function(){var e=this;e.initEvent()},initEvent:function(){var e=this;$(".noteSplit").bind("mousedown",function(t){t.preventDefault(),e.lineMove=!0,$(this).css("background-color","#ccc"),e.target=$(this).attr("id"),$("#noteMask").css("z-index",99999)}),e.mdSplitter.bind("mousedown",function(t){t.preventDefault(),$(this).hasClass("open")&&(e.mdLineMove=!0)}),e.body.bind("mousemove",function(t){e.lineMove?(t.preventDefault(),e.resize3Columns(t)):e.mdLineMove&&(t.preventDefault(),e.resizeMdColumns(t))}),e.body.bind("mouseup",function(t){e.stopResize(),$("#noteMask").css("z-index",-1)});var t;$(".layout-toggler-preview").click(function(){var o=$(this),i=e.leftColumn.parent();if(o.hasClass("open")){var n=i.width(),s=22,r=n-s;t=e.leftColumn.width(),e.leftColumn.width(r),e.rightColumn.css("left","auto").width(s),o.removeClass("open"),e.rightColumn.find(".layout-resizer").removeClass("open"),$(".preview-container").hide()}else o.addClass("open"),e.rightColumn.find(".layout-resizer").addClass("open"),e.leftColumn.width(t),$(".preview-container").show(),e.rightColumn.css("left",t).width("auto"),MD&&MD.onResize()})},stopResize:function(){var e=this;(e.lineMove||e.mdLineMove)&&ajaxGet("/user/updateColumnWidth",{mdEditorWidth:UserInfo.MdEditorWidth,notebookWidth:UserInfo.NotebookWidth,noteListWidth:UserInfo.NoteListWidth},function(){}),e.lineMove=!1,e.mdLineMove=!1,$(".noteSplit").css("background","none"),e.mdSplitter.css("background","none")},set3ColumnsWidth:function(e,t){var o=this;if(!(150>e||100>t)){var i=o.body.width()-e-t;400>i||(o.leftNotebook.width(e),o.notebookSplitter.css("left",e),o.noteAndEditor.css("left",e),o.noteList.width(t),o.noteSplitter.css("left",t),o.note.css("left",t),UserInfo.NotebookWidth=e,UserInfo.NoteListWidth=t)}},resize3Columns:function(e,t){var o=this;t&&(e.clientX+=o.body.width()-o.note.width());var i,n;o.lineMove&&("notebookSplitter"==o.target?(i=e.clientX,n=o.noteList.width(),o.set3ColumnsWidth(i,n)):(i=o.leftNotebook.width(),n=e.clientX-i,o.set3ColumnsWidth(i,n)),resizeEditor())},resizeMdColumns:function(e){var t=this;if(t.mdLineMove){var o=e.clientX-t.leftColumn.offset().left;t.setMdColumnWidth(o)}},setMdColumnWidth:function(e){var t=this;e>100&&(UserInfo.MdEditorWidth=e,log(e),t.leftColumn.width(e),t.rightColumn.css("left",e)),MD&&MD.onResize()}};Mobile={noteO:$("#note"),bodyO:$("body"),setMenuO:$("#setMenu"),hashChange:function(){var e=Mobile,t=location.hash;if(-1!=t.indexOf("noteId")){e.toEditor(!1);var o=t.substr(8);Note.changeNote(o,!1,!1)}else e.toNormal(!1)},init:function(){var e=this;e.isMobile()},isMobile:function(){var e=navigator.userAgent;return LEA.isMobile=!1,LEA.isMobile=/Mobile|Android|iPhone|iPad/i.test(e),LEA.isIpad=/iPad/i.test(e),LEA.isIphone=/iPhone/i.test(e),!LEA.isMobile&&$(document).width()<=700&&(LEA.isMobile=!0),LEA.isMobile},changeNote:function(e){var t=this;return LEA.isMobile?(t.toEditor(!0,e),!1):!0},toEditor:function(e,t){var o=this;o.bodyO.addClass("full-editor"),o.noteO.addClass("editor-show")},toNormal:function(e){var t=this;t.bodyO.removeClass("full-editor"),t.noteO.removeClass("editor-show")},switchPage:function(){var e=this;return!LEA.isMobile||LEA.isIpad?!0:(e.bodyO.hasClass("full-editor")?e.toNormal(!0):e.toEditor(!0),!1)}};var random=1;LEA.s3=new Date,console.log("initing..."),$(window).resize(function(){Mobile.isMobile(),resizeEditor()}),initEditor(),$(".folderHeader").click(function(){var e=$(this).next(),t=$(this).parent();e.is(":hidden")?($(".folderNote").removeClass("opened").addClass("closed"),t.removeClass("closed").addClass("opened"),$(this).find(".fa-angle-right").removeClass("fa-angle-right").addClass("fa-angle-down")):($(".folderNote").removeClass("opened").addClass("closed"),t.removeClass("opened").addClass("closed"),$(this).find(".fa-angle-down").removeClass("fa-angle-down").addClass("fa-angle-right"))}),$(".leanoteNav h1").on("click",function(e){var t=$(this).closest(".leanoteNav");t.hasClass("unfolder")?t.removeClass("unfolder"):t.addClass("unfolder")}),$("#setInfo").click(function(){openSetInfoDialog(0)}),$("#wrongEmail").click(function(){openSetInfoDialog(1)}),$("#setAvatarMenu").click(function(){showDialog2("#avatarDialog",{title:"头像设置",postShow:function(){}})}),$("#setTheme").click(function(){showDialog2("#setThemeDialog",{title:"主题设置",postShow:function(){UserInfo.Theme||(UserInfo.Theme="default"),$("#themeForm input[value='"+UserInfo.Theme+"']").attr("checked",!0)}})}),$("#themeForm").on("click","input",function(e){var t=$(this).val();$("#themeLink").attr("href","/css/theme/"+t+".css"),ajaxPost("/user/updateTheme",{theme:t},function(e){reIsOk(e)&&(UserInfo.Theme=t)})}),!UserInfo.Verified,$("#notebook, #newMyNote, #myProfile, #topNav, #notesAndSort","#leanoteNavTrigger").bind("selectstart",function(e){return e.preventDefault(),!1}),$("#leftSwitcher2").on("click",function(){maxLeft(!0)}),$("#leftSwitcher").click("click",function(){Mobile.switchPage()&&minLeft(!0)}),$("#notebookMin div.minContainer").click(function(){var e=$(this).attr("target");maxLeft(!0),"#notebookList"==e?$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click"):"#tagNav"==e?$("#myTag").hasClass("closed")&&$("#myTag .folderHeader").trigger("click"):$("#myShareNotebooks").hasClass("closed")&&$("#myShareNotebooks .folderHeader").trigger("click")}),UserInfo.NotebookWidth=UserInfo.NotebookWidth||$("#notebook").width(),UserInfo.NoteListWidth=UserInfo.NoteListWidth||$("#noteList").width(),Resize.init(),Resize.set3ColumnsWidth(UserInfo.NotebookWidth,UserInfo.NoteListWidth),Resize.setMdColumnWidth(UserInfo.MdEditorWidth),UserInfo.LeftIsMin&&minLeft(!1),$("#mainMask").html(""),$("#mainMask").hide(100),$(".dropdown").on("shown.bs.dropdown",function(){$(this).find("ul")}),$("#tipsBtn").click(function(){showDialog2("#tipsDialog")}),$("#yourSuggestions").click(function(){showDialog2("#suggestionsDialog")}),$("#suggestionBtn").click(function(e){e.preventDefault();var t=$.trim($("#suggestionTextarea").val());return t?($("#suggestionBtn").html("正在处理...").addClass("disabled"),$("#suggestionMsg").html("正在处理..."),void $.post("/suggestion",{suggestion:t},function(e){$("#suggestionBtn").html("提交").removeClass("disabled"),e.Ok?$("#suggestionMsg").html("谢谢反馈, 我们会第一时间处理, 祝您愉快!").addClass("alert-success").removeClass("alert-warning").show():$("#suggestionMsg").html("出错了").show().addClass("alert-warning").removeClass("alert-success")})):($("#suggestionMsg").html("请输入您的建议, 谢谢!").show().addClass("alert-warning").removeClass("alert-success"),void $("#suggestionTextarea").focus())}),em.init(),Mobile.init();var Pjax={init:function(){var e=this;window.addEventListener("popstate",function(t){var o=t.state;o&&(document.title=o.title||"Untitled",log("pop"),e.changeNotebookAndNote(o.noteId))},!1),history.pushState||$(window).on("hashchange",function(){var t=getHash("noteId");t&&e.changeNotebookAndNote(t)})},changeNotebookAndNote:function(e){var t=Note.getNote(e);if(t){var o=void 0!=t.Perm,i=t.NotebookId;return Notebook.curNotebookId==i?void Note.changeNoteForPjax(e,!1):void(o?Share.changeNotebook(t.UserId,i,function(t){Note.renderNotes(t),Note.changeNoteForPjax(e,!1,!0)}):Notebook.changeNotebook(i,function(t){Note.renderNotes(t),Note.changeNoteForPjax(e,!1,!0)}))}},changeNote:function(e){log("push");var t=e.NoteId,o=e.Title,i="/note/"+t;if(location.hash&&(i+=location.hash),history.pushState){var n={url:i,noteId:t,title:o};history.pushState(n,o,i),document.title=o||"Untitled"}else setHash("noteId",t)}};$(function(){Pjax.init()});
function revertTagStatus(){$("#addTagTrigger").show(),$("#addTagInput").hide()}function hideTagList(a){$("#tagDropdown").removeClass("open"),a&&a.stopPropagation()}function showTagList(a){$("#tagDropdown").addClass("open"),a&&a.stopPropagation()}function reRenderTags(){var a=["label label-default","label label-info"],e=0;$("#tags").children().each(function(){var t=$(this).attr("class");("label label-default"==t||"label label-info"==t)&&($(this).removeClass(t).addClass(a[e%2]),e++)})}Tag.classes={"蓝色":"label label-blue","红色":"label label-red","绿色":"label label-green","黄色":"label label-yellow",blue:"label label-blue",red:"label label-red",green:"label label-green",yellow:"label label-yellow"},Tag.mapCn2En={"蓝色":"blue","红色":"red","绿色":"green","黄色":"yellow"},Tag.mapEn2Cn={blue:"蓝色",red:"红色",green:"绿色",yellow:"黄色"},Tag.t=$("#tags"),Tag.getTags=function(){var a=[];return Tag.t.children().each(function(){var e=$(this).data("tag");e=Tag.mapCn2En[e]||e,a.push(e)}),a},Tag.clearTags=function(){Tag.t.html("")},Tag.renderTags=function(a){if(Tag.t.html(""),!isEmpty(a))for(var e=0;e<a.length;++e){var t=a[e];Tag.appendTag(t)}},Tag.renderReadOnlyTags=function(a){function e(){return t?"label label-default":(t=!0,"label label-info")}$("#noteReadTags").html(""),(isEmpty(a)||1==a.length&&""==a[0])&&$("#noteReadTags").html(getMsg("noTag"));var t=!0;for(var t in a){var l=a[t];l=Tag.mapEn2Cn[l]||l;var n=Tag.classes[l];n||(n=e()),tag=tt('<span class="?">?</span>',n,trimTitle(l)),$("#noteReadTags").append(tag)}},Tag.appendTag=function(a,e){var t,l,n=!1;if("object"==typeof a){if(t=a.classes,l=a.text,!l)return}else{if(a=$.trim(a),l=a,!l)return;var t=Tag.classes[l];t?n=!0:t="label label-default"}var g=l;"zh"==LEA.locale&&(l=Tag.mapEn2Cn[l]||l,g=Tag.mapCn2En[g]||g),a=tt('<span class="?" data-tag="?">?<i title="'+getMsg("delete")+'">X</i></span>',t,l,l);var r=!1;$("#tags").children().each(function(){if(n){var e=$("<div></div>").append($(this).clone()).html();e==a&&($(this).remove(),r=!0)}else l+"X"==$(this).text()&&($(this).remove(),r=!0)}),$("#tags").append(a),hideTagList(),n||reRenderTags(),e&&(Note.curNoteIsDirtied(),r||Note.curChangedSaveIt(!0,function(){ajaxPost("/tag/updateTag",{tag:g},function(a){reIsOk(a)&&Tag.addTagNav(a.Item)})}))},Tag.removeTag=function(a){var e=a.data("tag");a.remove(),reRenderTags(),"zh"==LEA.locale&&(e=Tag.mapCn2En[e]||e),Note.curChangedSaveIt(!0,function(){ajaxPost("/tag/updateTag",{tag:e},function(a){reIsOk(a)&&Tag.addTagNav(a.Item)})})},Tag.tags=[],Tag.renderTagNav=function(a){a=a||[],Tag.tags=a,$("#tagNav").html("");for(var e in a){var t=a[e],l=t.Tag,n=l;if("zh"==LEA.locale)var n=Tag.mapEn2Cn[l]||n;n=trimTitle(n);var g=Tag.classes[l]||"label label-default";$("#tagNav").append(tt('<li data-tag="?"><a> <span class="?">?</span> <span class="tag-delete">X</span></li>',l,g,n))}},Tag.addTagNav=function(a){var e=this;for(var t in e.tags){var l=e.tags[t];if(l.Tag==a.Tag){e.tags.splice(t,1);break}}e.tags.unshift(a),e.renderTagNav(e.tags)},$(function(){function a(){$li=$(this).closest("li");var a=$.trim($li.data("tag"));confirm("Are you sure ?")&&ajaxPost("/tag/deleteTag",{tag:a},function(e){if(reIsOk(e)){var t=e.Item;Note.deleteNoteTag(t,a),$li.remove()}})}function e(){var a=$(this).closest("li"),e=$.trim(a.data("tag"));Note.curChangedSaveIt(),Note.clearAll(),$("#tagSearch").html(a.html()).show(),$("#tagSearch .tag-delete").remove(),showLoading(),ajaxGet("/note/searchNoteByTags",{tags:[e]},function(a){hideLoading(),a&&(Note.renderNotes(a),isEmpty(a)||Note.changeNote(a[0].NoteId))})}$("#addTagTrigger").click(function(){$(this).hide(),$("#addTagInput").show().focus().val("")}),$("#addTagInput").click(function(a){showTagList(a)}),$("#addTagInput").blur(function(){var a=$(this).val();a&&Tag.appendTag(a,!0)}),$("#addTagInput").keydown(function(a){13==a.keyCode&&(hideTagList(),$("#addTagInput").val()?($(this).trigger("blur"),$("#addTagTrigger").trigger("click")):$(this).trigger("blur"))}),$("#tagColor li").click(function(a){var e;e=$(this).attr("role")?$(this).find("span"):$(this),Tag.appendTag({classes:e.attr("class"),text:e.text()},!0)}),$("#tags").on("click","i",function(){Tag.removeTag($(this).parent())}),$("#myTag .folderBody").on("click","li .label",e),$("#myTag .folderBody").on("click","li .tag-delete",a)});
Notebook.curNotebookId="",Notebook.cache={},Notebook.notebooks=[],Notebook.notebookNavForListNote="",Notebook.notebookNavForNewNote="",Notebook.setCache=function(o){var e=o.NotebookId;e&&(Notebook.cache[e]||(Notebook.cache[e]={}),$.extend(Notebook.cache[e],o))},Notebook.getCurNotebookId=function(){return Notebook.curNotebookId},Notebook.getCurNotebook=function(){return Notebook.cache[Notebook.curNotebookId]},Notebook._updateNotebookNumberNotes=function(o,e){var t=this,N=t.getNotebook(o);N&&(N.NumberNotes+=e,N.NumberNotes<0&&(N.NumberNotes=0),$("#numberNotes_"+o).html(N.NumberNotes))},Notebook.incrNotebookNumberNotes=function(o){var e=this;e._updateNotebookNumberNotes(o,1)},Notebook.minusNotebookNumberNotes=function(o){var e=this;e._updateNotebookNumberNotes(o,-1)},Notebook.getNotebook=function(o){return Notebook.cache[o]},Notebook.getNotebookTitle=function(o){var e=Notebook.cache[o];return e?e.Title:"未知"},Notebook.getTreeSetting=function(o,e){function t(o,t){var N=5,n=$("#"+o+" #"+t.tId+"_switch"),a=$("#"+o+" #"+t.tId+"_ico");if(n.remove(),a.before(n),e?Share.isDefaultNotebookId(t.NotebookId)||a.after($('<span class="fa notebook-setting" title="setting"></span>')):Notebook.isAllNotebookId(t.NotebookId)||Notebook.isTrashNotebookId(t.NotebookId)||(a.after($('<span class="notebook-number-notes" id="numberNotes_'+t.NotebookId+'">'+(t.NumberNotes||0)+"</span>")),a.after($('<span class="fa notebook-setting" title="setting"></span>'))),t.level>1){var r="<span style='display: inline-block;width:"+N*t.level+"px'></span>";n.before(r)}}function N(o,e){for(var t=0,N=e.length;N>t;t++)if(e[t].drag===!1)return!1;return!0}function n(o,e,t,N){return t?t.drop!==!1:!0}function a(o,e,t,N,n){function a(o){return o.level==d}var r=t[0];if(N){var i,k=b.tree,s={curNotebookId:r.NotebookId};if(i="inner"==n?N:N.getParentNode()){s.parentNotebookId=i.NotebookId;var d=i.level+1,l=k.getNodesByFilter(a,!1,i)}else var l=k.getNodes();s.siblings=[];for(var c in l){var h=l[c].NotebookId;Notebook.isAllNotebookId(h)||Notebook.isTrashNotebookId(h)||s.siblings.push(h)}ajaxPost("/notebook/dragNotebooks",{data:JSON.stringify(s)}),setTimeout(function(){Notebook.changeNav()},100)}}var r=!o,b=this;if(e)var i=function(o,e,t){var N=t.NotebookId,n=$(o.target).closest(".friend-notebooks").attr("fromUserId");Share.changeNotebook(n,N)},k=null;else var i=function(o,e,t){var N=t.NotebookId;Notebook.changeNotebook(N)},k=function(o){var e=$(o.target).attr("notebookId");Notebook.isAllNotebookId(e)||Notebook.isTrashNotebookId(e)||b.updateNotebookTitle(o.target)};var s={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1,addDiyDom:t},data:{key:{name:"Title",children:"Subs"}},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1,drag:{isMove:r,prev:r,inner:r,next:r}},callback:{beforeDrag:N,beforeDrop:n,onDrop:a,onClick:i,onDblClick:k,beforeRename:function(o,e,t,N){if(""==t)return e.IsNew?(b.tree.removeNode(e),!0):!1;if(e.Title==t)return!0;if(e.IsNew){var n=e.getParentNode(),a=n?n.NotebookId:"";b.doAddNotebook(e.NotebookId,t,a)}else b.doUpdateNotebookTitle(e.NotebookId,t);return!0}}};return s},Notebook.allNotebookId="0",Notebook.trashNotebookId="-1",Notebook.curNotebookIsTrashOrAll=function(){return Notebook.curNotebookId==Notebook.trashNotebookId||Notebook.curNotebookId==Notebook.allNotebookId},Notebook.renderNotebooks=function(o){var e=this;(!o||"object"!=typeof o||o.length<0)&&(o=[]);for(var t=0,N=o.length;N>t;++t){var n=o[t];n.Title=trimTitle(n.Title)}o=[{NotebookId:Notebook.allNotebookId,Title:getMsg("all"),drop:!1,drag:!1}].concat(o),o.push({NotebookId:Notebook.trashNotebookId,Title:getMsg("trash"),drop:!1,drag:!1}),Notebook.notebooks=o,e.tree=$.fn.zTree.init($("#notebookList"),e.getTreeSetting(),o);var a=$("#notebookList");a.hover(function(){$(this).hasClass("showIcon")||$(this).addClass("showIcon")},function(){$(this).removeClass("showIcon")}),isEmpty(o)||(Notebook.curNotebookId=o[0].NotebookId,e.cacheAllNotebooks(o)),Notebook.renderNav(),Notebook.changeNotebookNavForNewNote(o[0].NotebookId)},Notebook.cacheAllNotebooks=function(o){var e=this;for(var t in o){var N=o[t];Notebook.cache[N.NotebookId]=N,isEmpty(N.Subs)||e.cacheAllNotebooks(N.Subs)}},Notebook.expandNotebookTo=function(o,e){var t=this,N=!1,n=t.tree;if(e&&(n=Share.trees[e]),n){var a=n.getNodeByTId(o);if(a)for(;;){var r=a.getParentNode();if(!r){N||Notebook.changeNotebookNav(o);break}n.expandNode(r,!0),N||(Notebook.changeNotebookNav(o),N=!0),a=r}}},Notebook.renderNav=function(o){var e=this;e.changeNav()},Notebook.searchNotebookForAddNote=function(o){var e=this;if(o){var t=e.tree.getNodesByParamFuzzy("Title",o);t=t||[];var N=[];for(var n in t){var a=t[n].NotebookId;e.isAllNotebookId(a)||e.isTrashNotebookId(a)||N.push(t[n])}isEmpty(N)?$("#notebookNavForNewNote").html(""):$("#notebookNavForNewNote").html(e.getChangedNotebooks(N))}else $("#notebookNavForNewNote").html(e.everNavForNewNote)},Notebook.searchNotebookForList=function(o){var e=this,t=$("#notebookListForSearch"),N=$("#notebookList");if(o){t.show(),N.hide();var n=e.tree.getNodesByParamFuzzy("Title",o);if(log("search"),log(n),isEmpty(n))t.html("");else{var a=e.getTreeSetting(!0);e.tree2=$.fn.zTree.init(t,a,n)}}else e.tree2=null,t.hide(),N.show(),$("#notebookNavForNewNote").html(e.everNavForNewNote)},Notebook.getChangedNotebooks=function(o){for(var e=this,t="",N=o.length,n=0;N>n;++n){var a=o[n],r="";isEmpty(a.Subs)||(r="dropdown-submenu");var b=tt('<li role="presentation" class="clearfix ?"><div class="new-note-left pull-left" title="为该笔记本新建笔记" href="#" notebookId="?">?</div><div title="为该笔记本新建markdown笔记" class="new-note-right pull-left" notebookId="?">M</div>',r,a.NotebookId,a.Title,a.NotebookId);isEmpty(a.Subs)||(b+="<ul class='dropdown-menu'>",b+=e.getChangedNotebooks(a.Subs),b+="</ul>"),b+="</li>",t+=b}return t},Notebook.everNavForNewNote="",Notebook.everNotebooks=[],Notebook.changeNav=function(){var o=Notebook,e=Notebook.tree.getNodes(),t=e.slice(1,-1),N=o.getChangedNotebooks(t);o.everNavForNewNote=N,o.everNotebooks=t,$("#notebookNavForNewNote").html(N);var n=(new Date).getTime();Note.initContextmenu(),Share.initContextmenu(Note.notebooksCopy);var a=(new Date).getTime();log(a-n)},Notebook.renderShareNotebooks=function(o,e){if(!isEmpty(o)&&e&&"object"==typeof e&&!(e.length<0)){var t=$("#shareNotebooks"),N={};for(var n in e){var a=e[n];N[a.UserId]=a}for(var n in o){var r=o[n],a=N[r.UserId]||{ShareNotebooks:[]};a.ShareNotebooks=[{NotebookId:"-2",Title:"默认共享"}].concat(a.ShareNotebooks);var b=r.Username||r.Email,i=tt('<div class="folderNote closed"><div class="folderHeader"><a><h1 title="? 的共享"><i class="fa fa-angle-right"></i>?</h1></a></div>',b,b),k='<ul class="folderBody">';for(var s in a.ShareNotebooks){var d=a.ShareNotebooks[s];k+=tt('<li><a notebookId="?">?</a></li>',d.NotebookId,d.Title)}k+="</ul>",t.append(i+k+"</div>")}}},Notebook.selectNotebook=function(o){$(".notebook-item").removeClass("curSelectedNode"),$(o).addClass("curSelectedNode")},Notebook.changeNotebookNavForNewNote=function(o,e){if(!o){var t=Notebook.notebooks[0];o=t.NotebookId,e=t.Title}if(!e){var t=Notebook.cache[0];e=t.Title}if(Notebook.isAllNotebookId(o)||Notebook.isTrashNotebookId(o)){if(!$("#curNotebookForNewNote").attr("notebookId")&&Notebook.notebooks.length>2){var t=Notebook.notebooks[1];o=t.NotebookId,e=t.Title,Notebook.changeNotebookNavForNewNote(o,e)}}else $("#curNotebookForNewNote").html(e).attr("notebookId",o)},Notebook.toggleToMyNav=function(o,e){$("#sharedNotebookNavForListNav").hide(),$("#myNotebookNavForListNav").show(),$("#newMyNote").show(),$("#newSharedNote").hide(),$("#tagSearch").hide()},Notebook.changeNotebookNav=function(o){Notebook.curNotebookId=o,Notebook.toggleToMyNav(),Notebook.selectNotebook($(tt('#notebook [notebookId="?"]',o)));var e=Notebook.cache[o];e&&($("#curNotebookForListNote").html(e.Title),Notebook.changeNotebookNavForNewNote(o,e.Title))},Notebook.isAllNotebookId=function(o){return o==Notebook.allNotebookId},Notebook.isTrashNotebookId=function(o){return o==Notebook.trashNotebookId},Notebook.curActiveNotebookIsAll=function(){return Notebook.isAllNotebookId($("#notebookList .active").attr("notebookId"))},Notebook.changeNotebookSeq=1,Notebook.changeNotebook=function(o,e){var t=this;Notebook.changeNotebookNav(o),Notebook.curNotebookId=o,Note.curChangedSaveIt(),Note.clearAll();var N="/note/listNotes/",n={notebookId:o};if(Notebook.isTrashNotebookId(o))N="/note/listTrashNotes",n={};else if(Notebook.isAllNotebookId(o)){if(n={},cacheNotes=Note.getNotesByNotebookId(),!isEmpty(cacheNotes))return void(e?e(cacheNotes):Note.renderNotesAndFirstOneContent(cacheNotes))}else{cacheNotes=Note.getNotesByNotebookId(o);var a=Notebook.cache[o],r=cacheNotes?cacheNotes.length:0;if(r==a.NumberNotes)return void(e?e(cacheNotes):Note.renderNotesAndFirstOneContent(cacheNotes));Note.clearCacheByNotebookId(o),log("数量不一致")}t.showNoteAndEditorLoading(),t.changeNotebookSeq++,function(o){ajaxGet(N,n,function(N){return o!=t.changeNotebookSeq?(log("notebook changed too fast!"),void log(N)):(e?e(N):Note.renderNotesAndFirstOneContent(N),void t.hideNoteAndEditorLoading())})}(t.changeNotebookSeq)},Notebook.showNoteAndEditorLoading=function(){$("#noteAndEditorMask").show()},Notebook.hideNoteAndEditorLoading=function(){$("#noteAndEditorMask").hide()},Notebook.isCurNotebook=function(o){return"active"==$(tt('#notebookList [notebookId="?"], #shareNotebooks [notebookId="?"]',o,o)).attr("class")},Notebook.changeNotebookForNewNote=function(o){if(!Notebook.isTrashNotebookId(o)&&!Notebook.isAllNotebookId(o)){Notebook.changeNotebookNav(o,!0),Notebook.curNotebookId=o;var e="/note/listNotes/",t={notebookId:o};ajaxGet(e,t,function(o){Note.renderNotes(o,!0)})}},Notebook.listNotebookShareUserInfo=function(o){var e=$(o).attr("notebookId");showDialogRemote("/share/listNotebookShareUserInfo",{notebookId:e})},Notebook.shareNotebooks=function(o){var e=$(o).text();showDialog("dialogShareNote",{title:"分享笔记本给好友-"+e}),setTimeout(function(){$("#friendsEmail").focus()},500);var t=$(o).attr("notebookId");shareNoteOrNotebook(t,!1)},Notebook.setNotebook2Blog=function(o){var e=$(o).attr("notebookId"),t=Notebook.cache[e],N=!0;void 0!=t.IsBlog&&(N=!t.IsBlog),Notebook.curNotebookId==e?N?$("#noteList .item-blog").show():$("#noteList .item-blog").hide():Notebook.curNotebookId==Notebook.allNotebookId&&$("#noteItemList .item").each(function(){var o=$(this).attr("noteId"),t=Note.cache[o];t.NotebookId==e&&(N?$(this).find(".item-blog").show():$(this).find(".item-blog").hide())}),ajaxPost("/notebook/setNotebook2Blog",{notebookId:e,isBlog:N},function(o){o&&(Note.setAllNoteBlogStatus(e,N),Notebook.setCache({NotebookId:e,IsBlog:N}))})},Notebook.updateNotebookTitle=function(o){var e=Notebook,t=$(o).attr("notebookId");e.tree2?e.tree2.editName(e.tree2.getNodeByTId(t)):e.tree.editName(e.tree.getNodeByTId(t))},Notebook.doUpdateNotebookTitle=function(o,e){var t=Notebook;ajaxPost("/notebook/updateNotebookTitle",{notebookId:o,title:e},function(N){if(Notebook.cache[o].Title=e,Notebook.changeNav(),t.tree2){var n=t.tree.getNodeByTId(o);n.Title=e,t.tree.updateNode(n)}})},Notebook.addNotebookSeq=1,Notebook.addNotebook=function(){var o=Notebook;$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click"),o.tree.addNodes(null,{Title:"",NotebookId:getObjectId(),IsNew:!0},!0,!0)},Notebook.doAddNotebook=function(o,e,t){var N=Notebook;ajaxPost("/notebook/addNotebook",{notebookId:o,title:e,parentNotebookId:t},function(e){if(e.NotebookId){Notebook.cache[e.NotebookId]=e;var t=N.tree.getNodeByTId(o);$.extend(t,e),t.IsNew=!1,Notebook.changeNotebook(o),Notebook.changeNav()}})},Notebook.addChildNotebook=function(o){var e=Notebook;$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click");var t=$(o).attr("notebookId");e.tree.addNodes(e.tree.getNodeByTId(t),{Title:"",NotebookId:getObjectId(),IsNew:!0},!1,!0)},Notebook.deleteNotebook=function(o){var e=Notebook,t=$(o).attr("notebookId");t&&ajaxGet("/notebook/deleteNotebook",{notebookId:t},function(o){o.Ok?(e.tree.removeNode(e.tree.getNodeByTId(t)),e.tree2&&e.tree2.removeNode(e.tree2.getNodeByTId(t)),delete Notebook.cache[t],Notebook.changeNav()):alert(o.Msg)})},$(function(){function o(o){var e=$(this).attr("notebookId"),t=Notebook.cache[e];if(t){var N=[];t.IsBlog?N.push("set2Blog"):N.push("unset2Blog"),Note.notebookHasNotes(e)&&N.push("delete"),o.applyrule({name:"target2",disable:!0,items:N})}}function e(){var o=$(this).attr("notebookId");return!Notebook.isTrashNotebookId(o)&&!Notebook.isAllNotebookId(o)}$("#minNotebookList").on("click","li",function(){var o=$(this).find("a").attr("notebookId");Notebook.changeNotebook(o)});var t={width:180,items:[{text:getMsg("shareToFriends"),alias:"shareToFriends",icon:"",faIcon:"fa-share-square-o",action:Notebook.listNotebookShareUserInfo},{type:"splitLine"},{text:getMsg("publicAsBlog"),alias:"set2Blog",faIcon:"fa-bold",action:Notebook.setNotebook2Blog},{text:getMsg("cancelPublic"),alias:"unset2Blog",faIcon:"fa-undo",action:Notebook.setNotebook2Blog},{type:"splitLine"},{text:getMsg("addChildNotebook"),faIcon:"fa-sitemap",action:Notebook.addChildNotebook},{text:getMsg("rename"),faIcon:"fa-pencil",action:Notebook.updateNotebookTitle},{text:getMsg("delete"),icon:"",alias:"delete",faIcon:"fa-trash-o",action:Notebook.deleteNotebook}],onShow:o,onContextMenu:e,parent:"#notebookList ",children:"li a"},N={width:180,items:[{text:getMsg("shareToFriends"),alias:"shareToFriends",icon:"",faIcon:"fa-share-square-o",action:Notebook.listNotebookShareUserInfo},{type:"splitLine"},{text:getMsg("publicAsBlog"),alias:"set2Blog",faIcon:"fa-bold",action:Notebook.setNotebook2Blog},{text:getMsg("cancelPublic"),alias:"unset2Blog",faIcon:"fa-undo",action:Notebook.setNotebook2Blog},{type:"splitLine"},{text:getMsg("rename"),icon:"",action:Notebook.updateNotebookTitle},{text:getMsg("delete"),icon:"",alias:"delete",faIcon:"fa-trash-o",action:Notebook.deleteNotebook}],onShow:o,onContextMenu:e,parent:"#notebookListForSearch ",children:"li a"};Notebook.contextmenu=$("#notebookList li a").contextmenu(t),Notebook.contextmenuSearch=$("#notebookListForSearch li a").contextmenu(N),$("#addNotebookPlus").click(function(o){o.stopPropagation(),Notebook.addNotebook()}),$("#notebookList").on("click",".notebook-setting",function(o){o.preventDefault(),o.stopPropagation();var e=$(this).parent();Notebook.contextmenu.showMenu(o,e)}),$("#notebookListForSearch").on("click",".notebook-setting",function(o){o.preventDefault(),o.stopPropagation();var e=$(this).parent();Notebook.contextmenuSearch.showMenu(o,e)})});
function addShareNoteOrNotebook(e){var t="#tr"+e,o=Share.dialogNoteOrNotebookId,r=isEmailFromInput(t+" #friendsEmail","#shareMsg",getMsg("inputFriendEmail"));if(r){var a=$(t+' input[name="perm'+e+'"]:checked').val()||0,n=a,s="/share/addShareNote",i={noteId:o,emails:[r],perm:a};Share.dialogIsNote||(s="/share/addShareNotebook",i={notebookId:o,emails:[r],perm:a}),hideAlert("#shareMsg"),post(s,i,function(e){var e=e[r];if(e)if(e.Ok){var a=tt("<td>?</td>","#");a+=tt("<td>?</td>",r),a+=tt('<td><a href="#" noteOrNotebookId="?" perm="?" toUserId="?" title="'+getMsg("clickToChangePermission")+'" class="btn btn-default change-perm">?</a></td>',o,n,e.Id,n&&"0"!=n?getMsg("writable"):getMsg("readOnly")),a+=tt('<td><a href="#" noteOrNotebookId="?" toUserId="?" class="btn btn-warning delete-share">'+getMsg("delete")+"</a></td>",o,e.Id),$(t).html(a)}else{var s=UrlPrefix+"/register?iu="+UserInfo.Username;showAlert("#shareMsg",getMsg("friendNotExits",[getMsg("app"),'<input style="background: none;border: 1px solid #ccc;width: 300px;padding: 3px;border-radius: 3px;outline: none;" onclick="$(this).focus().select()" type="text" value="'+s+'" />'])+"</a> <br /> "+getMsg("sendInviteEmailToYourFriend")+', <a href="#" onclick="sendRegisterEmail(\''+r+"')\">"+getMsg("send"),"warning")}},t+" .btn-success")}}function sendRegisterEmail(e){showDialog2("#sendRegisterEmailDialog",{postShow:function(){$("#emailContent").val(getMsg("inviteEmailBody",[UserInfo.Username,getMsg("app")])),setTimeout(function(){$("#emailContent").focus()},500),$("#toEmail").val(e)}})}function deleteShareNoteOrNotebook(e){$("#tr"+e).remove()}Share.defaultNotebookId="share0",Share.defaultNotebookTitle=getMsg("defaulthhare"),Share.sharedUserInfos={},Share.userNavs={},Share.notebookCache={},Share.cache={},Share.dialogIsNote=!0,Share.setCache=function(e){e&&e.NoteId&&(Share.cache[e.NoteId]=e)},Share.getNotebooksForNew=function(e,t){for(var o=this,r="",a=t.length,n=0;a>n;++n){var s=t[n];s.IsShared=!0,s.UserId=e,o.notebookCache[s.NotebookId]=s,Notebook.cache[s.NotebookId]=s;var i="",d=!1;if(!isEmpty(s.Subs)){log(11),log(s.Subs);var d=o.getNotebooksForNew(e,s.Subs);d&&(i="dropdown-submenu")}var h="";if(s.Perm){var h=tt('<li role="presentation" class="clearfix ?" userId="?" notebookId="?"><div class="new-note-left pull-left" title="为该笔记本新建笔记" href="#">?</div><div title="为该笔记本新建markdown笔记" class="new-note-right pull-left">M</div>',i,e,s.NotebookId,s.Title);d&&(h+="<ul class='dropdown-menu'>",h+=d,h+="</ul>"),h+="</li>"}r+=h}return r},Share.trees={},Share.renderShareNotebooks=function(e,t){function o(e){}function r(){var e=$(this).attr("notebookId");return!Share.isDefaultNotebookId(e)}var a=Share;if(!isEmpty(e)){(!t||"object"!=typeof t||t.length<0)&&(t={});var n=$("#shareNotebooks");for(var s in e){var i=e[s],d=t[i.UserId]||[];userNotebooks=[{NotebookId:a.defaultNotebookId,Title:Share.defaultNotebookTitle}].concat(d),a.notebookCache[a.defaultNotebookId]=userNotebooks[0];var h=i.Username||i.Email;i.Username=h,Share.sharedUserInfos[i.UserId]=i;var l=i.UserId,c=tt('<li class="each-user"><div class="friend-header" fromUserId="?"><i class="fa fa-angle-down"></i><span>?</span> <span class="fa notebook-setting" title="setting"></span> </div>',i.UserId,h),N="friendContainer_"+l,u='<ul class="friend-notebooks ztree" id="'+N+'" fromUserId="'+l+'"></ul>';n.append(c+u+"</li>"),a.trees[l]=$.fn.zTree.init($("#"+N),Notebook.getTreeSetting(!0,!0),userNotebooks),a.userNavs[l]={forNew:a.getNotebooksForNew(l,d)},log(a.userNavs)}$(".friend-notebooks").hover(function(){$(this).hasClass("showIcon")||$(this).addClass("showIcon")},function(){$(this).removeClass("showIcon")}),$(".friend-header i").click(function(){var e=$(this),t=$(this).parent().next();t.is(":hidden")?(t.slideDown("fast"),e.removeClass("fa-angle-right fa-angle-down").addClass("fa-angle-down")):(t.slideUp("fast"),e.removeClass("fa-angle-right fa-angle-down").addClass("fa-angle-right"))});var f={width:180,items:[{text:getMsg("deleteSharedNotebook"),icon:"",faIcon:"fa-trash-o",action:Share.deleteShareNotebook}],onShow:o,onContextMenu:r,parent:"#shareNotebooks",children:".notebook-item"},b=$("#shareNotebooks").contextmenu(f),k={width:180,items:[{text:getMsg("deleteAllShared"),icon:"",faIcon:"fa-trash-o",action:Share.deleteUserShareNoteAndNotebook}],parent:"#shareNotebooks",children:".friend-header"},g=$("#shareNotebooks").contextmenu(k);$(".friend-header").on("click",".notebook-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();g.showMenu(e,t)}),$("#shareNotebooks .notebook-item").on("click",".notebook-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();b.showMenu(e,t)})}},Share.isDefaultNotebookId=function(e){return Share.defaultNotebookId==e},Share.toggleToSharedNav=function(e,t){$("#curNotebookForListNote").html(Share.notebookCache[t].Title+"("+Share.sharedUserInfos[e].Username+")");var o=Share.userNavs[e].forNew;if(o){$("#notebookNavForNewSharedNote").html(o);var r="",a="";if(Share.notebookCache[t].Perm)r=t,a=Share.notebookCache[t].Title;else{var n=$("#notebookNavForNewSharedNote li").eq(0);r=n.attr("notebookId"),a=n.find(".new-note-left").text()}$("#curNotebookForNewSharedNote").html(a+"("+Share.sharedUserInfos[e].Username+")"),$("#curNotebookForNewSharedNote").attr("notebookId",r),$("#curNotebookForNewSharedNote").attr("userId",e),$("#newSharedNote").show(),$("#newMyNote").hide()}else $("#newMyNote").show(),$("#newSharedNote").hide();$("#tagSearch").hide()},Share.firstRenderShareNote=function(e,t,o){$("#myShareNotebooks .folderHeader").trigger("click"),Notebook.expandNotebookTo(t,e),Share.changeNotebook(e,t,function(e){Note.renderNotes(e),Note.changeNoteForPjax(o,!1,!1)})},Share.changeNotebook=function(e,t,o){var r=this;Notebook.curNotebookId=t;var a=$(tt('#friendContainer_? a[notebookId="?"]',e,t));0==a.length?(Notebook.selectNotebook($(tt('#friendContainer_? a[notebookId="?"]',e,r.defaultNotebookId))),t=r.defaultNotebookId):Notebook.selectNotebook(a),Share.toggleToSharedNav(e,t),Note.curChangedSaveIt(),Note.clearAll();var n="/share/listShareNotes",s={userId:e};Share.isDefaultNotebookId(t)||(s.notebookId=t),ajaxGet(n,s,function(e){s.notebookId,o?o(e):(Note.renderNotes(e,!1,!0),isEmpty(e)||Note.changeNoteForPjax(e[0].NoteId,!0,!1))})},Share.hasUpdatePerm=function(e){var t=Share.cache[e];return t||(t=Note.getNote(e)),t&&t.Perm?!0:!1},Share.deleteShareNotebook=function(e){if(confirm("Are you sure to delete it?")){var t=$(e).attr("notebookId"),o=$(e).closest(".friend-notebooks").attr("fromUserId");ajaxGet("/share/DeleteShareNotebookBySharedUser",{notebookId:t,fromUserId:o},function(t){t&&$(e).parent().remove()})}},Share.deleteShareNote=function(e){var t=$(e).attr("noteId"),o=$(e).attr("fromUserId");ajaxGet("/share/DeleteShareNoteBySharedUser",{noteId:t,fromUserId:o},function(t){t&&$(e).remove()})},Share.deleteUserShareNoteAndNotebook=function(e){if(confirm("Are you sure to delete all shared notebooks and notes?")){var t=$(e).attr("fromUserId");ajaxGet("/share/deleteUserShareNoteAndNotebook",{fromUserId:t},function(t){t&&$(e).parent().remove()})}},Share.changeNotebookForNewNote=function(e){Notebook.selectNotebook($(tt('#shareNotebooks [notebookId="?"]',e)));var t=Share.notebookCache[e].UserId;Share.toggleToSharedNav(t,e);var o="/share/listShareNotes",r={userId:t,notebookId:e};ajaxGet(o,r,function(e){Note.renderNotes(e,!0,!0)})},Share.deleteSharedNote=function(e,t){Note.deleteNote(e,t,!0)},Share.copySharedNote=function(e,t){Note.copyNote(e,t,!0)},Share.contextmenu=null,Share.initContextmenu=function(e){function t(e){var t=$(this).attr("noteId"),o=Share.cache[t];if(o){var r=[];o.Perm&&o.CreatedUserId==UserInfo.UserId||r.push("delete"),e.applyrule({name:"target...",disable:!0,items:r})}}Share.contextmenu&&Share.contextmenu.destroy();var o={width:180,items:[{text:getMsg("copyToMyNotebook"),alias:"copy",faIcon:"fa-copy",type:"group",width:180,items:e},{type:"splitLine"},{text:getMsg("delete"),alias:"delete",icon:"",faIcon:"fa-trash-o",action:Share.deleteSharedNote}],onShow:t,parent:"#noteItemList",children:".item-shared"};Share.contextmenu=$("#noteItemList .item-shared").contextmenu(o)},$(function(){$("#noteItemList").on("click",".item-shared .item-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();Share.contextmenu.showMenu(e,t)}),$("#newSharedNoteBtn").click(function(){var e=$("#curNotebookForNewSharedNote").attr("notebookId"),t=$("#curNotebookForNewSharedNote").attr("userId");Note.newNote(e,!0,t)}),$("#newShareNoteMarkdownBtn").click(function(){var e=$("#curNotebookForNewSharedNote").attr("notebookId"),t=$("#curNotebookForNewSharedNote").attr("userId");Note.newNote(e,!0,t,!0)}),$("#notebookNavForNewSharedNote").on("click","li div",function(){var e=$(this).parent().attr("notebookId"),t=$(this).parent().attr("userId");"M"==$(this).text()?Note.newNote(e,!0,t,!0):Note.newNote(e,!0,t)}),$("#leanoteDialogRemote").on("click",".change-perm",function(){var e=this,t=$(this).attr("perm"),o=$(this).attr("noteOrNotebookId"),r=$(this).attr("toUserId"),a=getMsg("writable"),n="1";"1"==t&&(a=getMsg("readOnly"),n="0");var s="/share/updateShareNotebookPerm",i={perm:n,toUserId:r};Share.dialogIsNote?(s="/share/updateShareNotePerm",i.noteId=o):i.notebookId=o,ajaxGet(s,i,function(t){t&&($(e).html(a),$(e).attr("perm",n))})}),$("#leanoteDialogRemote").on("click",".delete-share",function(){var e=this,t=$(this).attr("noteOrNotebookId"),o=$(this).attr("toUserId"),r="/share/deleteShareNotebook",a={toUserId:o};Share.dialogIsNote?(r="/share/deleteShareNote",a.noteId=t):a.notebookId=t,ajaxGet(r,a,function(t){t&&$(e).parent().parent().remove()})});var e=1;$("#leanoteDialogRemote").on("click","#addShareNotebookBtn",function(){e++;var t='<tr id="tr'+e+'"><td>#</td><td><input id="friendsEmail" type="text" class="form-control" style="width: 200px" placeholder="'+getMsg("friendEmail")+'"/></td>';t+='<td><label for="readPerm'+e+'"><input type="radio" name="perm'+e+'" checked="checked" value="0" id="readPerm'+e+'"> '+getMsg("readOnly")+"</label>",t+=' <label for="writePerm'+e+'"><input type="radio" name="perm'+e+'" value="1" id="writePerm'+e+'"> '+getMsg("writable")+"</label></td>",t+='<td><button class="btn btn-success" onclick="addShareNoteOrNotebook('+e+')">'+getMsg("share")+"</button>",t+=' <button class="btn btn-warning" onclick="deleteShareNoteOrNotebook('+e+')">'+getMsg("delete")+"</button>",t+="</td></tr>",$("#shareNotebookTable tbody").prepend(t),$("#tr"+e+" #friendsEmail").focus()}),$("#registerEmailBtn").click(function(){var e=$("#emailContent").val(),t=$("#toEmail").val();return e?void post("/user/sendRegisterEmail",{content:e,toEmail:t},function(e){showAlert("#registerEmailMsg",getMsg("sendSuccess"),"success"),hideDialog2("#sendRegisterEmailDialog",1e3)},this):void showAlert("#registerEmailMsg",getMsg("emailBodyRequired"),"danger")})});